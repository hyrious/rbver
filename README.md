# rbver

Ruby doc with version info.

You can download [the json format file](versions.json),
or [the marshal one](versions.ri).

The structure of this file is:

```json
{
  "ClassName": {
    "i": { "instance_method1": 30 },
    "c": { "class_method1": 90 },
    "a": { "attribute1": 160 },
    "_": 100
  }
}
```

The number followed by a method/attribute is the version of ruby - 100.
Which means `93` is `ruby_1_9_3`, `160` is `ruby_2_6_0`, etc.
I choose this way to store the number mainly because in ruby marshal numbers
under 127 will only takes one byte to store. :p

~~It seems that~~ We can write a [monkey script](rbver.user.js) to https://ruby-doc.org to show
the versions.

## Script

The `versions.ri` file was generated by:

1. `git clone https://github.com/ruby/ruby` (very slow)
2. `ruby ruby-doc.rb`, the `ruby-doc.rb`'s content is given below.  
   note that this file only runs on windows. modify it before you run it.
   ```ruby
   require 'fileutils'
   include FileUtils

   BRANCHES = %w{
     ruby_1_3
     ruby_1_4
     ruby_1_6
     ruby_1_8
     ruby_1_8_5
     ruby_1_8_6
     ruby_1_8_7
     ruby_1_9_1
     ruby_1_9_2
     ruby_1_9_3
     ruby_2_0_0
     ruby_2_1
     ruby_2_2
     ruby_2_3
     ruby_2_4
     ruby_2_5
     ruby_2_6
   }

   ID = Hash[BRANCHES.map do |e|
     /(?<a>\d)_(?<b>\d)(?:_(?<c>\d))?/ =~ e
     id = a.to_i * 100 + b.to_i * 10 + c.to_i - 100
     [e, id]
   end]

   # cache.ri [
   # > ancestors {'ClassName' => ['ParentClass', 'GrandParentClass']}
   # > attributes {'ClassName' => ['attr_reader name','attr_write cat']}
   # > class_methods {'ClassName' => ['new']}
   #   c_class_variables {'a.c' => {'rb_func' => 'A::Func'}}
   #   c_singleton_class_variables {'ruby/marshal.c' => {'c' => nil}}
   # > instance_methods {'A' => ['a']}
   #   main nil
   # > modules ['M']
   #   pages ['ruby/README.md']
   #   title nil
   # ]

   # VersionInfo['A'] = { i: { 'a' => id }, c:, a:, _: 30 }
   VersionInfo = {}

   BRANCHES.each do |b|
     id = ID[b]
     cd 'ruby' do
       system "git checkout #{b}"
     end
     system 'rdoc --all --ri --op rdoc ruby'
     cache = Marshal.load IO.binread 'rdoc/cache.ri'
     cache[:ancestors].each_key do |mod|
       VersionInfo[mod] ||= { i: {}, c: {}, a: {}, _: id }
     end
     %i[attributes class_methods instance_methods].each do |k|
       kk = k.to_s[0].to_sym
       cache[k].each do |klass, xs|
         xs.each do |x|
           VersionInfo[klass] ||= { i: {}, c: {}, a: {}, _: id }
           VersionInfo[klass][kk][x] ||= id
         end
       end
     end
   ensure
     system '>nul del /s/f/q rdoc'
     system 'rd /s/q rdoc'
   end

   IO.binwrite 'versions.ri', Marshal.dump(VersionInfo)
   ```

## License

:shit: WTFPL.
